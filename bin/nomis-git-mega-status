#!/usr/bin/env bash
set -e

#### ___________________________________________________________________________
#### Description
####
#### Search recursively for Git repos and produce status reports on them.
#### Use red output to highlight differences between local and remote.
#### Use white output for other info such as branch names.
####
#### Usage:
####   nomis-git-mega-status [<options-1>] [-- [<options-2>]]
####     where
####       <options-1> = options for nomis-do-to-all-git-repos
####       <options-2> = options for nomis-git-status
####
####   See nomis-do-to-all-git-repos and nomis-git-status for details of
####   their options.
####
#### Examples of use:
####
####   nomis-git-mega-status
####     Produce a report for each repo that has something different between
####     local and remote, showing just those differences.
####     Also reports any current non-master branches.
####
####   nomis-git-mega-status -- -m
####     Does not report on current non-master branches.
####
####   nomis-git-mega-status -f
####     Produce a report for each repo, showing just the differences between
####     local and remote. Include reports with empty bodies (ie with just a
####     heading identifying the repo).
####
####   nomis-git-mega-status -- -v
####     Produce a full report on each repo.
####
####   nomis-git-mega-status -f -- -v | less -NR
####     Produce a big report and pipe the output into `less`. The -N option
####     gives line numbers and the -R option deals with ANSI color codes.

#### ___________________________________________________________________________
#### Options and usage

args_before_double_dash=
args_after_double_dash=

doing_args_before_double_dash_p="YES"

while [[ $# -gt 0 ]]
do
    if [[ "$1" == "--" ]] ; then
        doing_args_before_double_dash_p=
    else
        if [[ "${doing_args_before_double_dash_p}" ]] ; then
            args_before_double_dash="${args_before_double_dash} $1"
        else
            args_after_double_dash="${args_after_double_dash} $1"
        fi
    fi
    shift
done

#### ___________________________________________________________________________
#### Main functionality

nomis-do-to-all-git-repos ${args_before_double_dash} \
                          nomis-git-status ${args_after_double_dash}
